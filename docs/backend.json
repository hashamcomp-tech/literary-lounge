{
  "entities": {
    "UserProfile": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "UserProfile",
      "type": "object",
      "description": "Represents a user's profile information, excluding authentication details.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the UserProfile entity."
        },
        "displayName": {
          "type": "string",
          "description": "The public display name of the user."
        },
        "email": {
          "type": "string",
          "description": "The user's contact email address.",
          "format": "email"
        },
        "createdAt": {
          "type": "string",
          "description": "Timestamp when the user profile was created.",
          "format": "date-time"
        },
        "updatedAt": {
          "type": "string",
          "description": "Timestamp when the user profile was last updated.",
          "format": "date-time"
        }
      },
      "required": [
        "id",
        "displayName",
        "email",
        "createdAt",
        "updatedAt"
      ]
    },
    "Novel": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Novel",
      "type": "object",
      "description": "Represents a literary novel, including its metadata and content details.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the Novel entity."
        },
        "title": {
          "type": "string",
          "description": "The title of the novel."
        },
        "authorName": {
          "type": "string",
          "description": "The name of the novel's author."
        },
        "description": {
          "type": "string",
          "description": "A brief synopsis or summary of the novel."
        },
        "coverImageUrl": {
          "type": "string",
          "description": "URL to the novel's cover image.",
          "format": "uri"
        },
        "publicationDate": {
          "type": "string",
          "description": "The date when the novel was first published.",
          "format": "date-time"
        },
        "genres": {
          "type": "array",
          "description": "A list of genres associated with the novel.",
          "items": {
            "type": "string"
          }
        },
        "language": {
          "type": "string",
          "description": "The primary language of the novel (e.g., 'en', 'es')."
        },
        "createdAt": {
          "type": "string",
          "description": "Timestamp when the novel record was created.",
          "format": "date-time"
        },
        "updatedAt": {
          "type": "string",
          "description": "Timestamp when the novel record was last updated.",
          "format": "date-time"
        }
      },
      "required": [
        "id",
        "title",
        "authorName",
        "description",
        "coverImageUrl",
        "publicationDate",
        "genres",
        "language",
        "createdAt",
        "updatedAt"
      ]
    },
    "Chapter": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Chapter",
      "type": "object",
      "description": "Represents a single chapter within a novel.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the Chapter entity."
        },
        "novelId": {
          "type": "string",
          "description": "Reference to the Novel this chapter belongs to. (Relationship: Novel 1:N Chapter)"
        },
        "chapterNumber": {
          "type": "number",
          "description": "The sequential number of the chapter within the novel."
        },
        "title": {
          "type": "string",
          "description": "The title of the chapter."
        },
        "content": {
          "type": "string",
          "description": "The full text content of the chapter."
        },
        "wordCount": {
          "type": "number",
          "description": "The total number of words in the chapter."
        },
        "createdAt": {
          "type": "string",
          "description": "Timestamp when the chapter record was created.",
          "format": "date-time"
        },
        "updatedAt": {
          "type": "string",
          "description": "Timestamp when the chapter record was last updated.",
          "format": "date-time"
        }
      },
      "required": [
        "id",
        "novelId",
        "chapterNumber",
        "title",
        "content",
        "wordCount",
        "createdAt",
        "updatedAt"
      ]
    },
    "ReadingProgress": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "ReadingProgress",
      "type": "object",
      "description": "Tracks a user's reading progress for a specific novel and chapter.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the ReadingProgress entity."
        },
        "userId": {
          "type": "string",
          "description": "Reference to the UserProfile who owns this reading progress. (Relationship: UserProfile 1:N ReadingProgress)"
        },
        "novelId": {
          "type": "string",
          "description": "Reference to the Novel being read. (Relationship: Novel 1:N ReadingProgress)"
        },
        "currentChapterId": {
          "type": "string",
          "description": "Reference to the Chapter the user is currently reading or last read. (Relationship: Chapter 1:N ReadingProgress)"
        },
        "lastReadPosition": {
          "type": "number",
          "description": "A numeric value representing the user's progress within the current chapter (e.g., percentage, scroll position, or word index)."
        },
        "isCompleted": {
          "type": "boolean",
          "description": "Indicates whether the user has marked the novel as completed."
        },
        "startedAt": {
          "type": "string",
          "description": "Timestamp when the user started reading this novel.",
          "format": "date-time"
        },
        "lastReadAt": {
          "type": "string",
          "description": "Timestamp when the reading progress was last updated.",
          "format": "date-time"
        }
      },
      "required": [
        "id",
        "userId",
        "novelId",
        "currentChapterId",
        "lastReadPosition",
        "isCompleted",
        "startedAt",
        "lastReadAt"
      ]
    },
    "UserPreference": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "UserPreference",
      "type": "object",
      "description": "Stores a user's reading preferences for personalized recommendations.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the UserPreference entity."
        },
        "userId": {
          "type": "string",
          "description": "Reference to the UserProfile this preference belongs to. (Relationship: UserProfile 1:1 UserPreference)"
        },
        "preferredGenres": {
          "type": "array",
          "description": "A list of genres the user prefers.",
          "items": {
            "type": "string"
          }
        },
        "preferredAuthors": {
          "type": "array",
          "description": "A list of authors whose works the user prefers.",
          "items": {
            "type": "string"
          }
        },
        "dislikedGenres": {
          "type": "array",
          "description": "A list of genres the user dislikes or wants to avoid in recommendations.",
          "items": {
            "type": "string"
          }
        },
        "createdAt": {
          "type": "string",
          "description": "Timestamp when the user preferences were created.",
          "format": "date-time"
        },
        "updatedAt": {
          "type": "string",
          "description": "Timestamp when the user preferences were last updated.",
          "format": "date-time"
        }
      },
      "required": [
        "id",
        "userId",
        "preferredGenres",
        "preferredAuthors",
        "dislikedGenres",
        "createdAt",
        "updatedAt"
      ]
    }
  },
  "auth": {
    "providers": [
      "password",
      "anonymous"
    ]
  },
  "firestore": {
    "structure": [
      {
        "path": "/users/{userId}",
        "definition": {
          "entityName": "UserProfile",
          "schema": {
            "$ref": "#/backend/entities/UserProfile"
          },
          "description": "Stores individual user profiles. The document ID `{userId}` must match the authenticated user's `uid`. This collection represents private data, directly owned by the user. Includes denormalized 'id' and 'email' fields for authorization independence."
        }
      },
      {
        "path": "/novels/{novelId}",
        "definition": {
          "entityName": "Novel",
          "schema": {
            "$ref": "#/backend/entities/Novel"
          },
          "description": "Stores general novel metadata. This is public content, readable by all authenticated users (or guests, depending on final rule setting). It supports global listing and searching. The 'id' field in the document matches `{novelId}`."
        }
      },
      {
        "path": "/novels/{novelId}/chapters/{chapterId}",
        "definition": {
          "entityName": "Chapter",
          "schema": {
            "$ref": "#/backend/entities/Chapter"
          },
          "description": "Stores individual chapters belonging to a specific novel. Chapters are public content, readable by all authenticated users. The 'novelId' field within the document is denormalized from the parent path for authorization independence and query efficiency."
        }
      },
      {
        "path": "/users/{userId}/readingProgress/{readingProgressId}",
        "definition": {
          "entityName": "ReadingProgress",
          "schema": {
            "$ref": "#/backend/entities/ReadingProgress"
          },
          "description": "Tracks a user's reading progress for specific novels and chapters. This is private data, exclusively owned by the user. The 'userId' in the path and document ensures authorization independence (request.auth.uid == userId)."
        }
      },
      {
        "path": "/users/{userId}/userPreferences/{userPreferenceId}",
        "definition": {
          "entityName": "UserPreference",
          "schema": {
            "$ref": "#/backend/entities/UserPreference"
          },
          "description": "Stores a user's reading preferences. This is private data, exclusively owned by the user. For a 1:1 relationship, 'userPreferenceId' should typically be the same as 'userId'. The 'userId' in the path and document ensures authorization independence (request.auth.uid == userId)."
        }
      }
    ],
    "reasoning": "The Firestore structure for Literary Lounge is designed to prioritize authorization independence, clear segregation of data by security posture, and predictable access patterns. \n\n**Authorization Independence:**\n\n1.  **User-specific Data (`/users/{userId}/...`)**: User profiles, reading progress, and preferences are organized under `/users/{userId}`. This path-based ownership ensures that authorization rules can directly check `request.auth.uid == userId` without needing to perform `get()` operations on parent documents. The `userId` is explicitly embedded in the path and typically denormalized into the document itself (e.g., `ReadingProgress.userId`, `UserPreference.userId`), fulfilling the critical mandate to avoid hierarchical authorization dependencies. This allows for atomic writes and transactions across user-owned documents without complex rule evaluation.\n\n2.  **Public Content (`/novels/{novelId}/...`)**: Novels and their chapters are placed in top-level collections (`/novels` and `/novels/{novelId}/chapters`). Since these are intended to be broadly accessible (e.g., to all authenticated users or publicly), their authorization does not depend on owner attributes or membership maps. Access rules can simply allow reads for all authenticated users, eliminating `get()` calls for content authorization.\n\n**QAPs (Rules are not Filters) Support:**\n\n1.  **Public Content (`/novels`, `/novels/{novelId}/chapters`)**: These collections have a homogeneous security posture (e.g., all documents are readable by authenticated users). This allows `list` queries on these collections (e.g., searching for novels, listing chapters) to naturally return all accessible documents without Firestore security rules having to filter the results. The rules simply grant read access to the entire collection.\n\n2.  **User-Owned Data (`/users/{userId}/readingProgress`, `/users/{userId}/userPreferences`)**: `list` queries on subcollections like `/users/{userId}/readingProgress` are inherently scoped by the `userId` in the path. When a user requests their own reading progress, the query path will contain their `uid` (e.g., `/users/ABC/readingProgress`). The security rule `request.auth.uid == userId` then applies to all documents within that requested path, ensuring that `list` operations only return data the user is authorized to see, without the rules acting as filters on a broader dataset. This perfectly supports QAPs by making the query inherently secure through its path structure.\n\n**Structural Segregation & Access Modeling:**\n\n*   **User Profiles (`/users/{userId}`)**: Uses path-based ownership, with the document ID (`userId`) matching the authenticated user's UID. This is the standard for private user data.\n*   **Novels (`/novels/{novelId}`)**: A top-level collection for content, allowing for easy global search and display. Access is broadly granted.\n*   **Chapters (`/novels/{novelId}/chapters/{chapterId}`)**: Nested under novels, maintaining the content hierarchy. Chapters inherently carry the `novelId` within their path, simplifying rule validation.\n*   **Reading Progress (`/users/{userId}/readingProgress/{readingProgressId}`)**: Nested under the user's path, clearly indicating personal ownership. The `readingProgressId` is unique per entry.\n*   **User Preferences (`/users/{userId}/userPreferences/{userPreferenceId}`)**: Nested under the user's path, with the `userPreferenceId` being the `userId` itself, enforcing the 1:1 relationship and strong ownership. \n\nThis design ensures robust security, simplifies rule writing, and scales effectively by avoiding common pitfalls associated with complex, interdependent authorization logic."
  }
}